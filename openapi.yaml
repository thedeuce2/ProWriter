openapi: 3.1.0
info:
  title: ProWriter Backend Actions
  version: 1.0.4
servers:
  - url: https://prowriter-4jdv.onrender.com

paths:
  /health:
    get:
      operationId: healthCheck
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /:
    get:
      operationId: serviceInfo
      summary: Service info
      responses:
        "200":
          description: Info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/canon-digest:
    get:
      operationId: getCanonDigest
      summary: List available canon artifacts in the default project
      responses:
        "200":
          description: Digest
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CanonDigestResponse"

  /v1/artifacts:
    get:
      operationId: listArtifacts
      summary: List artifacts (default project), optionally filtered by type
      parameters:
        - name: type
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/ArtifactType"
      responses:
        "200":
          description: Artifacts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ArtifactListResponse"

  /v1/artifacts/{type}/{artifactName}:
    put:
      operationId: upsertGenericArtifact
      summary: Upsert an artifact (default project)
      parameters:
        - name: type
          in: path
          required: true
          schema:
            $ref: "#/components/schemas/ArtifactType"
        - name: artifactName
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ArtifactUpsertRequest"
      responses:
        "200":
          description: Upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

    get:
      operationId: getGenericArtifactLatest
      summary: Get latest artifact (default project)
      parameters:
        - name: type
          in: path
          required: true
          schema:
            $ref: "#/components/schemas/ArtifactType"
        - name: artifactName
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Latest
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/artifacts/{type}/{artifactName}/revisions:
    get:
      operationId: listGenericArtifactRevisions
      summary: List revisions for an artifact (default project)
      parameters:
        - name: type
          in: path
          required: true
          schema:
            $ref: "#/components/schemas/ArtifactType"
        - name: artifactName
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Revisions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ArtifactRevisionListResponse"

  /v1/artifacts/{type}/{artifactName}/revisions/{revisionNumber}:
    get:
      operationId: getGenericArtifactRevision
      summary: Get a specific revision for an artifact (default project)
      parameters:
        - name: type
          in: path
          required: true
          schema:
            $ref: "#/components/schemas/ArtifactType"
        - name: artifactName
          in: path
          required: true
          schema: { type: string }
        - name: revisionNumber
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: Revision
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/style-profiles/{profileName}:
    put:
      operationId: upsertStyleProfile
      summary: Upsert a style profile (default project)
      parameters:
        - name: profileName
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StyleProfile"
      responses:
        "200":
          description: Upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

    get:
      operationId: getStyleProfile
      summary: Get latest style profile (default project)
      parameters:
        - name: profileName
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Latest
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/character-sheets/{sheetName}:
    put:
      operationId: upsertCharacterSheet
      summary: Upsert a character sheet (default project)
      parameters:
        - name: sheetName
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CharacterSheet"
      responses:
        "200":
          description: Upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

    get:
      operationId: getCharacterSheet
      summary: Get latest character sheet (default project)
      parameters:
        - name: sheetName
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Latest
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/draft-directives:
    post:
      operationId: createDraftDirective
      summary: Store a draft directive as an artifact (default project)
      parameters:
        - name: directiveName
          in: query
          required: false
          schema: { type: string }
          description: Optional name; defaults to "current" on the server
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DraftDirective"
      responses:
        "200":
          description: Stored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/revision-plans:
    post:
      operationId: createRevisionPlan
      summary: Generate/store a revision plan (default project)
      parameters:
        - name: planName
          in: query
          required: false
          schema: { type: string }
          description: Optional name; defaults to "current" on the server
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevisionPlanRequest"
      responses:
        "200":
          description: Stored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/diagnostics/prose:
    post:
      operationId: proseDiagnostics
      summary: Run prose diagnostics and store a quality report (default project)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProseDiagnosticRequest"
      responses:
        "200":
          description: Stored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenericObjectResponse"

  /v1/projects:
    post:
      operationId: createProject
      summary: Create a project (optional; ProWriter does not require this)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectCreateRequest"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectCreateResponse"

    get:
      operationId: listProjects
      summary: List projects (optional)
      responses:
        "200":
          description: Projects
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectListResponse"

components:
  schemas:
    # --- validator-friendly generic object ---
    GenericObjectResponse:
      type: object
      description: Generic object response (placeholder property included for strict validators).
      properties:
        _:
          type: string
          description: Placeholder property
      additionalProperties: true

    HealthResponse:
      type: object
      additionalProperties: false
      properties:
        ok:
          type: boolean
      required: [ok]

    ArtifactType:
      type: string
      enum:
        - style_profile
        - character_sheet
        - draft_directive
        - revision_plan
        - quality_report
        - freeform_note

    ArtifactSummary:
      type: object
      additionalProperties: false
      properties:
        type:
          $ref: "#/components/schemas/ArtifactType"
        name:
          type: string
        schema_version:
          type: integer
        updated_at:
          type: string
          format: date-time
      required: [type, name, schema_version, updated_at]

    ArtifactListResponse:
      type: object
      additionalProperties: false
      properties:
        artifacts:
          type: array
          items:
            $ref: "#/components/schemas/ArtifactSummary"
      required: [artifacts]

    ArtifactRevisionListResponse:
      type: object
      additionalProperties: false
      properties:
        revisions:
          type: array
          items:
            type: object
            additionalProperties: false
            properties:
              revision_number:
                type: integer
                minimum: 1
              created_at:
                type: string
                format: date-time
            required: [revision_number, created_at]
      required: [revisions]

    ArtifactUpsertRequest:
      type: object
      additionalProperties: false
      properties:
        schema_version:
          type: integer
          minimum: 1
        payload:
          type: object
          description: JSON payload for this artifact
          properties:
            _:
              type: string
          additionalProperties: true
      required: [schema_version, payload]

    CanonDigestResponse:
      type: object
      additionalProperties: false
      properties:
        project_id:
          type: string
        style_profiles:
          type: array
          items: { type: string }
        characters:
          type: array
          items: { type: string }
        draft_directives:
          type: array
          items: { type: string }
      required: [project_id, style_profiles, characters, draft_directives]

    StyleProfile:
      type: object
      additionalProperties: true
      properties:
        schema_version: { type: integer, minimum: 1 }
        label: { type: string }
      required: [schema_version, label]

    CharacterSheet:
      type: object
      additionalProperties: true
      properties:
        schema_version: { type: integer, minimum: 1 }
        name: { type: string }
      required: [schema_version, name]

    DraftDirective:
      type: object
      additionalProperties: true
      properties:
        schema_version: { type: integer, minimum: 1 }
        deliverable:
          type: string
          enum: [scene, chapter, cold_open, synopsis, pitch, query_letter, outline]
        pov: { type: string }
        tense:
          type: string
          enum: [past, present]
        objective: { type: string }
        conflict: { type: string }
        stakes: { type: string }
        beats:
          type: array
          items:
            type: object
            additionalProperties: true
            properties:
              purpose: { type: string }
              event: { type: string }
      required: [schema_version, deliverable, pov, tense, objective, conflict, stakes, beats]

    RevisionPlanRequest:
      type: object
      additionalProperties: false
      properties:
        schema_version: { type: integer, minimum: 1 }
        mode:
          type: string
          enum: [humanize, marketability, tighten, voice_match, clarity, dialogue_punchup, pacing]
      required: [schema_version, mode]

    ProseDiagnosticRequest:
      type: object
      additionalProperties: false
      properties:
        schema_version: { type: integer, minimum: 1 }
        text: { type: string, minLength: 1, maxLength: 200000 }
        directive_name: { type: string }
        style_profile_name: { type: string }
      required: [schema_version, text]

    ProjectCreateRequest:
      type: object
      additionalProperties: false
      properties:
        name: { type: string }
      required: [name]

    ProjectCreateResponse:
      type: object
      additionalProperties: false
      properties:
        project_id: { type: string }
      required: [project_id]

    ProjectListResponse:
      type: object
      additionalProperties: false
      properties:
        projects:
          type: array
          items:
            type: object
            additionalProperties: false
            properties:
              project_id: { type: string }
              name:
                anyOf:
                  - type: string
                  - type: "null"
              created_at: { type: string, format: date-time }
              updated_at: { type: string, format: date-time }
            required: [project_id, name, created_at, updated_at]
      required: [projects]
